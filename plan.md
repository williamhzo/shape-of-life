# Conway Arena (Shape L2) v0.1 Spec and Implementation Plan

This document defines a flexible v0.1 spec for a multiplayer, onchain Conway’s Game of Life experience on Shape L2, plus a detailed implementation plan aligned with the preferred stack: TypeScript, Next.js (App Router + route handlers), Tailwind, shadcn/ui, Hardhat, Foundry, wagmi, viem, Vitest, Turborepo, Bun, and Alchemy RPC.

## 0. Goals

Build a spectator-first, multiplayer arena where:
- Many players participate in the same round (social, shared world).
- Players sign only 2 transactions per round (commit + reveal), plus optional claim/mint.
- Simulation is deterministic and executed onchain in batches.
- Outcomes are neutral and verifiable (contract state is canonical).
- Gas costs remain low via packed bitboards, bounded board size, bounded participants.

Shape-native: optionally recycle Shape Gasback proceeds into prize pools and keeper incentives. Shape Gasback returns 80% of sequencer (L2) fees generated by interactions with registered contracts to contract owners once registered.  
Refs:
- https://docs.shape.network/building-on-shape/gasback

---

## 1. Glossary

- **Season**: A long-running configuration epoch (parameters, scoring weights, cosmetics, reward strategy).
- **Round**: One match with a fixed board, fixed phase windows, deterministic simulation.
- **Team**: Blue or Red (Immigration two-color model).
- **Seedlet**: A small pattern contributed by one player (bitmask).
- **Slot**: A predefined spawn location reserved during commit, used to place a seedlet at round start.
- **Keeper**: Any address calling `stepBatch` to advance simulation.

---

## 2. Core Automaton Rules

### 2.1 Cell state
Each cell is:
- Dead
- Alive (Blue)
- Alive (Red)

We maintain two disjoint bitboards: `blue` and `red`. A cell is alive if `(blue | red) == 1` for that cell. Invariant: `blue & red == 0`.

### 2.2 Neighborhood
Standard Moore neighborhood (8 adjacent cells).

### 2.3 Life rule (B3/S23)
- Dead cell is born with exactly 3 live neighbors.
- Live cell survives with 2 or 3 live neighbors.
- Otherwise it dies/stays dead.

Refs:
- https://conwaylife.com/wiki/Conway%27s_Game_of_Life
- https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life

### 2.4 Color rule (Immigration)
- Survivors keep their color.
- Newborn cell (always 3 neighbors under B3 births) takes the **majority color** of its three neighbors.

Refs:
- https://conwaylife.com/wiki/Colourised_life

### 2.5 Topology
Default v1 topology: **Cylinder**
- Wrap on Y (vertical): row -1 → row 63, row 64 → row 0.
- Hard edges on X (horizontal): out-of-bounds is dead.

Topology is configurable per season/round.

---

## 3. Board and Packing

### 3.1 Board size
Default: **64×64** (4096 cells).

Optional future variants:
- 96×64 or 128×64 (wider battlefield).
- 128×128 (heavier compute; requires tighter tick limits/batching).

### 3.2 Packed representation (storage)
For 64×64:
- Represent each row as 64 bits (`uint64`).
- Pack 4 rows into one `uint256` (4 × 64 = 256).
- 64 rows → 16 `uint256` words per team.

Per round storage:
- `uint256[16] bluePacked`
- `uint256[16] redPacked`

In-memory stepping uses:
- `uint64[64] blueRows`
- `uint64[64] redRows`

On `stepBatch`:
1. Unpack packed words → row arrays
2. Step N generations in memory
3. Repack and write back once

This reduces SSTORE writes.

---

## 4. Seedlets, Slots, and Participation

### 4.1 Seedlet size and cell budget
Default v1:
- Seedlet: **8×8** stored as `uint64`
- Budget: **K = 12** live cells (tunable)

This supports many participants per round while keeping overlap and compute bounded.

Optional “pro rounds”:
- Seedlet: 16×16 stored as `uint256` with budget K ≈ 32
- Fewer slots or larger board

### 4.2 Slot grid and team territories
For 64×64 with 8×8 seedlets:
- 8×8 slot grid → **64 slots**
- Team allocation by tile column:
  - Blue: tileX in [0..3] (x 0..31)
  - Red: tileX in [4..7] (x 32..63)

Result: 32 slots per team, no overlap by construction.

### 4.3 Slot reservation rules
- Commit reserves exactly one slot.
- One commit per slot.
- At most one reserved slot per address (v1).

### 4.4 Client-side transforms
Allowed before committing:
- rotate 90/180/270
- mirror X/Y
- translate inside 8×8 seedlet

Onchain stores only the resulting bitmask.

### 4.5 Commit hash encoding
Commit preimage binds:
- `roundId`
- `chainId` (required)
- `arena` (contract address, required)
- `player`
- `team`
- `slotIndex`
- `seedBits`
- `salt`

Example:
`commitHash = keccak256(abi.encode(roundId, block.chainid, address(this), player, team, slotIndex, seedBits, salt))`

Including `player` and `arena` prevents copying another reveal and replaying across deployments.

---

## 5. Round Lifecycle

### 5.1 Phases
1. Commit
2. Reveal
3. Simulation
4. Claim

`finalize(roundId)` is a transition action from `Simulation -> Claim`, not a standalone phase in v0.1.

### 5.2 Timing defaults (configurable)
- Commit: 90s
- Reveal: 60s
- Simulation: until `maxGen` or early end
- `maxGen`: 256
- `maxBatch`: start with 16 or 32 and tune via benchmarking

### 5.3 Liveness
- Permissionless stepping with keeper rewards
- Official keeper bot to avoid stalls, but anyone may step and earn rewards

### 5.4 Transition guards (v0.1)
- `commit`: only in Commit, before `commitEnd`, valid team/slot, empty slot, and one reserved slot per address.
- `reveal`: only in Reveal, before `revealEnd`, caller must match committed player, preimage must match `commitHash`, budget must be `<= seedBudget`, one reveal only.
- `initialize`: callable once after `revealEnd`; builds initial board from revealed slots only; sets phase to Sim.
- `stepBatch`: only in Sim; advances `actualSteps = min(requestedSteps, maxBatch, maxGen - gen)`; keeper reward uses `actualSteps` only.
- `finalize`: only in Sim when `gen == maxGen` or one team is extinct; computes scores/winner and sets phase to Claim.
- `claim`: only in Claim; only revealed slot owner can claim; one claim per slot.

---

## 6. End Conditions and Scoring

### 6.1 End conditions
Round ends when:
- `gen == maxGen`, or
- one team is extinct (its entire bitboard is empty); early termination is enabled by default in v0.1

### 6.2 Recommended v1 scoring (cheap and watchable)
Avoid per-tick scoring onchain in v1. Compute score at finalize.

At final generation:
- `finalPopBlue = popcount(blue)`
- `finalPopRed  = popcount(red)`
- `invadeBlue   = popcount(blue ∩ rightHalf)` (x >= 32)
- `invadeRed    = popcount(red  ∩ leftHalf)`  (x < 32)

Score:
- `scoreBlue = 3*finalPopBlue + 2*invadeBlue`
- `scoreRed  = 3*finalPopRed  + 2*invadeRed`

Winner:
- If one team extinct: other team wins
- Else: higher score wins

### 6.3 Tiebreakers
v1 recommendation:
- Draw splits winner pool equally across all revealed participants (both teams), and both teams may mint the artifact

Optional deterministic coinflip:
- `keccak256(roundId, finalBoardHash)` parity

Optional VRF later:
- Shape Gelato VRF guide: https://docs.shape.network/tools/oracles/gelato-vrf

---

## 7. Economy and Shape-Native Features

### 7.1 Round types
1) Casual (free entry)
- No entry fee
- No reservation bond by default (`reservationBond = 0`)
- No payout (or sponsored)
- Rewards: leaderboards, badges, artifacts

2) Ranked (paid entry)
- Entry fee per commit
- Prize pool split among:
  - winning team participants (revealed slots only)
  - keepers (steppers)
  - protocol/treasury (optional)

### 7.2 Non-reveal penalty
Committed but not revealed:
- Slot remains empty
- In ranked: fee forfeited to pools (prize/keepers)
- If `reservationBond > 0`, bond is forfeited to pools on non-reveal

### 7.3 Keeper rewards
A `keeperPool` funded by:
- portion of entry fees and/or
- sponsorship and/or
- treasury recycling (including Gasback proceeds)

Reward per generation advanced:
- `rewardPerGen`
- Pay on `stepBatch` proportional to actual generations advanced

Cap total keeper rewards per round:
- `rewardPerGen * maxGen`
- On each `stepBatch`, `keeperReward = min(actualSteps * rewardPerGen, keeperPoolRemaining)` (never overpay)

### 7.4 Locked v0.1 payout model (low stakes)
For ranked rounds, use simple fixed shares:
- `winnerBps = 8000` (80%)
- `keeperBps = 2000` (20%)
- `treasuryBps = 0`
- Invariant: `winnerBps + keeperBps + treasuryBps == 10000`

Pool formulas:
- `totalEntry = entryFee * commitCount`
- `winnerPool = totalEntry * winnerBps / 10000`
- `keeperPool = totalEntry * keeperBps / 10000`
- `keeperPoolRemaining = keeperPool - keeperPaid`
- `winnerPoolFinal = winnerPool + keeperPoolRemaining` (unused keeper budget rolls to winners)

Claim formulas:
- If Blue or Red wins:
  - `revealedWinnerCount = # revealed slots on winning team`
  - `payoutPerWinner = winnerPoolFinal / revealedWinnerCount` (equal share)
- If Draw:
  - `revealedBothCount = # revealed slots across both teams`
  - `payoutPerParticipant = winnerPoolFinal / revealedBothCount` (equal share)
- If divisor is zero (`revealedWinnerCount == 0` or `revealedBothCount == 0`), no participant claims are enabled and `winnerPoolFinal` is sent to `treasury`.

Rounding:
- Integer division dust goes to `treasury` to avoid stuck balance.

Eligibility:
- Only revealed slots can claim.

### 7.5 Low-stakes anti-griefing defaults
- Casual starts fully free (`entryFee = 0`, `reservationBond = 0`) to keep friction minimal.
- Ranked uses entry fees as the primary anti-spam cost.
- Existing onchain controls remain mandatory: one commit per slot and one reserved slot per address.
- If spam becomes a problem, set `reservationBond > 0` in a later season without contract migration.

### 7.6 Gasback loop
Register arena contracts for Gasback and periodically claim into a treasury. Recycle into:
- sponsored rounds
- keeper pools
- seasonal prize pools

Refs:
- https://docs.shape.network/building-on-shape/gasback
- https://docs.shape.network/tutorials/registering-contract-gasback/programmatically

### 7.7 Stack medals and reputation
Plan to emit events or integrate later with Shape Stack:
- https://docs.shape.network/the-stack

---

## 8. Smart Contract Specification

### 8.1 Contract layout
- `ConwayArena`: round state machine, commits/reveals, stepping, finalization, payouts
- `ConwayEngine` (library): pack/unpack, stepping, popcount utilities
- Optional: `RoundArtifactNFT` (ERC-1155 or ERC-721)

### 8.2 Enums
- `Phase { Commit, Reveal, Sim, Claim }`
- `Team { Blue, Red }`
- `Topology { HardEdges, Torus, Cylinder }`

### 8.3 Round config (per round or per season)
- `width = 64`, `height = 64`
- `topology = Cylinder`
- `maxGen = 256`
- `earlyExtinction = true`
- `seedSize = 8` (8×8)
- `seedBudget = 12`
- `commitDuration = 90s`
- `revealDuration = 60s`
- `maxBatch = 16..32`
- `scoreWeightPop = 3`
- `scoreWeightInvade = 2`
- `entryFee` (0 for casual)
- `reservationBond` (default 0)
- `winnerBps = 8000`
- `keeperBps = 2000`
- `treasuryBps = 0`
- `rewardPerGen` (optional)
- `treasury` (receives dust and optional protocol share)

### 8.4 Storage structures (suggested)
- `mapping(uint256 => RoundCore) rounds`
- `mapping(uint256 => mapping(uint8 => Slot)) slots`

`RoundCore`:
- `Phase phase`
- `uint40 commitEnd`
- `uint40 revealEnd`
- `uint16 gen`
- `uint256[16] bluePacked`
- `uint256[16] redPacked`
- `bool initialized`
- `bool finalized`
- `uint32 scoreBlue`
- `uint32 scoreRed`
- `uint8 winner` (0 Blue, 1 Red, 2 Draw)
- `uint256 winnerPool`
- `uint256 keeperPoolRemaining`
- `uint256 keeperPaid`

`Slot`:
- `address player`
- `uint8 team`
- `bytes32 commitHash`
- `uint64 seedBits`
- `bool revealed`
- `bool claimed`

### 8.5 Public functions

Round management:
- `createRound(Config cfg)` (admin v1)
- `getRoundState(roundId)` view

Commit:
- `commit(roundId, team, slotIndex, commitHash)` payable

Reveal:
- `reveal(roundId, team, slotIndex, seedBits, salt)`

Initialize:
- `initialize(roundId)` (anyone after reveal ends or called implicitly in step)

Stepping:
- `stepBatch(roundId, steps)` (permissionless, pays keeper reward)

Finalize:
- `finalize(roundId)` (permissionless once end condition met)

Claim:
- `claim(roundId, slotIndex)`
- `previewClaim(roundId, slotIndex)` view

Artifacts (optional):
- `mintArtifact(roundId)` (participants or winners)

### 8.6 Events
- `RoundCreated(roundId, cfg)`
- `Committed(roundId, player, team, slotIndex)`
- `Revealed(roundId, player, team, slotIndex, seedHash)`
- `Initialized(roundId)`
- `Stepped(roundId, fromGen, toGen, keeper, reward)`
- `Finalized(roundId, winner, scoreBlue, scoreRed, finalBoardHash, winnerPoolFinal, keeperPaid)`
- `Claimed(roundId, player, slotIndex, amount)`
- `ArtifactMinted(roundId, player, tokenId)`

### 8.7 Access control and safety
- Owner/admin controls for round creation, config, pausing, treasury
- `nonReentrant` on claim
- Pull payments
- Cap keeper payouts
- Validate config invariants (`winnerBps + keeperBps + treasuryBps == 10000`)
- Validate invariants (`blue & red == 0`)

---

## 9. Offchain System Specification

### 9.1 Frontend (Next.js App Router + Tailwind + shadcn/ui)
Pages:
1) Spectator Home
- live board, phase timer, gen counter, populations, join CTA

2) Join Flow
- team select / auto-balance
- slot picker
- 8×8 seed editor + presets + transforms + budget meter
- commit tx + reveal tx

3) Round Live View
- local animation between onchain checkpoints
- keeper feed + participant list (from indexer)

4) End Screen
- winner summary, claim, artifact mint, replay share

Rendering:
- `<canvas>` with `ImageData` for efficient 64×64 scaling.

Wallet:
- wagmi + viem

API surface:
- Next.js App Router route handlers (`app/api/**/route.ts`) for server-side endpoints (health, replay metadata, indexer-backed reads).

### 9.2 Indexing
Start with a TS-first indexer for speed:
- Ponder (recommended for iteration)
Then optionally move to hosted:
- Goldsky / Alchemy Subgraphs

Shape data indexer refs:
- https://docs.shape.network/tools/data-indexers

### 9.3 Simulation worker and artifacts
A Node worker replays rounds from revealed seeds + config to generate:
- replay JSON
- thumbnail(s)
- mp4/gif share asset

Store on IPFS/Arweave or CDN and reference via metadata hash.

### 9.4 Keeper bot
Bot watches rounds in Sim phase and calls `stepBatch` with safe `stepsPerCall`.
Even with bot, keep stepping permissionless.

### 9.5 RPC provider
- Use Alchemy as the default RPC provider for Shape Sepolia and Shape Mainnet.
- Configure `SHAPE_SEPOLIA_RPC_URL` and `SHAPE_MAINNET_RPC_URL` with Alchemy endpoints (API key provided by operator).

---

## 10. Implementation Plan (Preferred Stack)

### Phase A: Prototype the fun (offchain-first)
Goal: validate watchability and game feel.
1) TypeScript engine (same rules/topology/seedlets/slots/scoring).
2) Next.js UI (spectator-first + seed editor + local sim rendering).
3) Replay artifacts generated offchain.
4) Vitest test harness for `packages/sim` and App Router API utilities.

Deliverable: fully playable offchain prototype.

### Phase B: Solidity engine (Foundry-first)
Goal: correctness and gas profiling.
Tooling: Foundry for tests/fuzzing/gas snapshots.

Tasks:
1) pack/unpack utilities (rows ↔ packed words)
2) step-one-generation engine (Immigration + cylinder topology)
3) popcount utilities
4) golden tests (fixtures from TS engine)
5) fuzz comparisons: Solidity vs TS for random boards over multiple steps

Deliverable: `ConwayEngine` library with high confidence.

### Phase C: Round manager contract (Foundry + integration)
Tasks:
1) round state machine + deadlines
2) slot commit/reveal + budget enforcement
3) initialize() from revealed seeds (bounded loop)
4) stepBatch() in-memory stepping and single write-back
5) finalize() scoring (final pop + invasion)
6) claim() pull payouts with reentrancy guard

Deliverable: end-to-end playable on local and Shape Sepolia.

### Phase D: Deployments and scripts (Hardhat + viem)
Recommendation: Use Hardhat for deployment/verification/scripts, Foundry for tests.

- Use `@nomicfoundation/hardhat-toolbox-viem` for viem-first tooling.
Ref:
- https://hardhat.org/docs/plugins/hardhat-toolbox-viem

Network setup:
- Shape Sepolia: chainId 11011, RPC via `SHAPE_SEPOLIA_RPC_URL` (Alchemy)
- Shape Mainnet: chainId 360, RPC via `SHAPE_MAINNET_RPC_URL` (Alchemy)
Ref:
- https://docs.shape.network/technical-details/network-information

Deliverable: reproducible deployments (Ignition modules) + CI.

### Phase E: Indexer + production UI
Tasks:
1) indexer (Ponder) for round/slot/step events
2) realtime UI: slot occupancy, reveal status, keeper feed
3) UX polish: minimal wallet prompts, optimistic slot reservation

Deliverable: production-grade spectator-first app.

### Phase F: Shape-native features
1) Gasback registration and treasury loop
Refs:
- https://docs.shape.network/building-on-shape/gasback
- https://docs.shape.network/tutorials/registering-contract-gasback/programmatically

2) Stack alignment (events first, medals later)
Ref:
- https://docs.shape.network/the-stack

3) Optional VRF for tiebreaks / randomized slot assignment
Ref:
- https://docs.shape.network/tools/oracles/gelato-vrf

Deliverable: native incentives and identity.

---

## 11. Repo Structure (recommended)

Monorepo (Turborepo + Bun workspaces):
- Root:
  - `turbo.json`
  - `package.json` (Bun workspaces)
  - `bunfig.toml`
- `apps/web` (Next.js App Router + `app/api/**/route.ts`)
- `packages/contracts` (Foundry + Hardhat)
  - `src/`, `test/`, `foundry.toml`
  - `hardhat.config.ts`, `ignition/`, `scripts/`
- `packages/sim` (TS engine + fixtures)
- `packages/indexer` (Ponder)

Key principle: use the TS engine to generate Solidity test fixtures.
Refs:
- https://turborepo.dev/docs
- https://bun.com/docs

---

## 12. Hardhat vs Foundry Guidance

Use both, with boundaries:
- Foundry: unit tests, fuzzing, invariants, gas snapshots
- Hardhat: deployments (Ignition), viem-based scripts, verification
- Vitest: TypeScript unit/integration tests for `packages/sim`, `packages/indexer`, and `apps/web` API/util modules

---

## 13. Correctness and Failure Modes Checklist

1) Engine neighbor counting bugs
- Mitigate with golden vectors + fuzz comparisons vs TS engine.

2) Packing/unpacking misalignment
- Mitigate with invertibility tests and explicit pack layout tests.

3) Topology mismatch (cylinder wrap)
- Enforce identical behavior in TS and Solidity.

4) Keeper reward abuse
- Pay only for generations advanced; cap total rewards per round.

5) Round liveness
- Permissionless stepping + official keeper bot.

6) Claim safety
- Pull payments + `nonReentrant` + careful accounting.

---

## 14. v1 Defaults Summary

- Board: 64×64
- Topology: cylinder (wrap Y, hard X)
- Teams: Blue vs Red (Immigration)
- Seedlet: 8×8 (`uint64`)
- Budget: 12 cells
- Slots: 64 total (32 per team)
- Commit: 90s
- Reveal: 60s
- MaxGen: 256
- Early extinction: enabled
- MaxBatch: 16 or 32 (benchmark on Shape Sepolia)
- RPC provider: Alchemy (`SHAPE_SEPOLIA_RPC_URL`, `SHAPE_MAINNET_RPC_URL`)
- Testing: Vitest (TS) + Foundry (Solidity)
- Web API: Next.js App Router route handlers (`app/api/**/route.ts`)
- Score: `3*finalPop + 2*invasionPop`
- Modes: Casual (free), Ranked (fee + payouts + keeper rewards)
- Ranked split: winners 80%, keepers 20%, treasury 0% (plus dust)
- Winner payouts: equal share across revealed winning slots (or all revealed slots on draw)
- Casual anti-spam default: `reservationBond = 0` (can be enabled later)

---

## 15. Immediate Next Steps

1) Build TS engine + UI prototype to validate game feel.
2) Implement Solidity engine in Foundry with TS fixture comparisons.
3) Deploy to Shape Sepolia and benchmark `stepBatch` gas to set safe `maxBatch`.
4) Integrate indexer and ship spectator-first MVP.

---

## 16. Execution Structure (Impact-Ordered)

### Objective
Lock a low-stakes but production-safe v0.1 by prioritizing correctness and accounting clarity before polish.

### Scope
- In: deterministic engine parity, state-machine safety, payouts, keeper economics, Turborepo+Bun monorepo workflow.
- Out: weighted contribution rewards, advanced anti-sybil systems, VRF-dependent gameplay.

### Impact-Ordered Priorities
- P0:
  - Finalize transition semantics (`Sim -> Claim`) with explicit guard matrix.
  - Deterministic payout math (winner/keeper pools, draw handling, dust handling).
  - Replay protection (`chainId` + `arena` in commit hash).
  - Keeper shortfall safety (`min(...)` reward clamp).
- P1:
  - Gas envelope and benchmark thresholds on Shape Sepolia for all critical tx paths.
  - End-to-end tests for non-reveal forfeits and one-claim-only safety.
  - Team assignment and slot-policy consistency between UI and contract.
- P2:
  - Event completeness for indexer reconciliation and accounting audits.
  - Turborepo task graph + Bun workspace ergonomics in CI.
- P3:
  - Optional VRF tiebreaks, richer reward tuning, Stack medal integrations.

### Action Items
[x] Add state-machine tests covering every allowed/disallowed transition.
[x] Add payout invariant tests: total payouts + keeper paid + dust <= funded amount.
[x] Add keeper reward tests for underfunded and over-requested step batches.
[x] Add TS/Solidity parity fixtures for topology edge cases (cylinder wrap boundaries).
[x] Add commit/reveal payload validation tests and enforce slot reservation/ownership + seed budget guards.
[x] Add slot-claim ownership/idempotency tests and enforce one-claim-only claim path.
[x] Add keeper pull-withdraw payout plumbing with no-credit guard and transfer tests.
[x] Add winner payout transfer plumbing for winner-team/draw slot claims with deterministic equal-share distribution.
[x] Disable manual settlement griefing for accounting rounds and auto-route zero-eligible winner pools at finalize.
[x] Add explicit non-reentrancy guard on transfer paths (`claim`, `withdrawKeeperCredit`) with cross-function probe test.
[x] Enforce round funding invariant at accounting configuration (`totalFunded <= contract balance`) to fail early.
[ ] Add Sepolia benchmarking script and lock `maxBatch` via measured thresholds.
[x] Add indexer reconciliation checks against `Stepped`, `Finalized`, and `Claimed` events.

### Validation
- Foundry fuzz/invariant suite passes for state transitions, accounting, and claim idempotency.
- Vitest suite passes for `packages/sim`, `packages/indexer`, and `apps/web` API/util paths.
- TS vs Solidity golden tests show zero divergence across random seeds and multiple generations.
- Sepolia benchmark confirms safe gas headroom for chosen `maxBatch`.

### Risks
- Sybil slot capture in free casual mode: monitor and enable `reservationBond` when abuse appears.
- Economic complexity drift: keep v0.1 on equal-share winner payouts; defer weighted rewards.

---

## 17. Testing-First Delivery Mandate (TDD)

This section is additive and overrides execution style across all phases: core logic/rules/state/accounting features are delivered using strict TDD (Red -> Green -> Refactor), with tests written before implementation code and merged only when all gates pass. Frontend UI presentation is validated in a live browser session instead of component-markup tests.

### 17.1 Global TDD Rules (non-optional)

1) Red first
- For each core logic/rule/state/accounting behavior change, write at least one failing test first (unit/integration/invariant as appropriate).
- Commit history should show test-first progression for non-trivial features.

2) Green with minimal code
- Implement the smallest change that makes failing tests pass.
- Do not batch unrelated features in a single change.

3) Refactor with safety
- Refactor only with test suite green.
- Add regression tests for every discovered bug before fixing.

4) No-test-no-merge policy
- Any new core logic path without tests blocks merge.
- Any production core-logic bug fix without a reproducer test blocks merge.
- Frontend UI behavior changes require live browser validation notes in progress logs, not component-markup tests.

### 17.2 Phase 1: Test Harness Foundation (before feature expansion)

Goals:
- Make tests easy to write/run locally and in CI.
- Standardize deterministic fixtures shared by TS and Solidity.

Tasks:
- Add workspace-level test commands for each package and a root aggregate command (`bun run test` + package-specific targets).
- Add deterministic RNG seeding utilities and fixture builders for board/slot states.
- Add snapshot/golden fixture versioning strategy (`fixtures/v1/...`) with review workflow.
- Add CI matrix for `packages/sim`, `packages/contracts`, `packages/indexer`, `apps/web`.

Deliverable:
- One-command full test execution and reproducible fixture generation.

### 17.3 Phase 2: Engine TDD Matrix (TS + Solidity parity)

Goals:
- Prove deterministic automaton correctness before contract integration.

Required tests:
- Unit tests for pack/unpack invertibility and row/word alignment.
- Rule tests for B3/S23 + Immigration color majority behavior.
- Topology boundary tests (cylinder wrap on Y, hard edges on X).
- Property/fuzz tests for random boards across multiple generations.
- Cross-implementation parity tests (TS oracle vs Solidity) on fixed and random vectors.
- Invariant tests (`blue & red == 0`, stable popcount bounds, deterministic replay hash).

Exit criteria:
- Zero parity divergence across golden vectors and fuzz corpus.

### 17.4 Phase 3: Round State Machine TDD (contract behavior)

Goals:
- Guarantee lifecycle and accounting safety under adversarial usage.

Required tests:
- Transition matrix tests for all phase gates (allowed + forbidden calls).
- Commit/reveal tests: replay protection, wrong player/team/slot/salt rejection.
- Budget enforcement tests (`seedBudget`) with exact boundary cases.
- Initialize and step batching tests (`actualSteps` clamping, no overstep past `maxGen`).
- Finalize tests for extinction, max-gen completion, tie handling.
- Claim tests: one-claim-only, zero-eligible divisors, dust routing to treasury.
- Reentrancy and pull-payment safety tests.
- Invariant tests: `winnerPool + keeperPaid + treasuryDust <= totalFunded`.

Exit criteria:
- Full lifecycle simulation tests pass for casual and ranked rounds.

### 17.5 Phase 4: Integration + E2E Validation (indexer, scripts, browser UI checks)

Goals:
- Validate user-visible behavior and event reconciliation end-to-end.

Required checks:
- Browser UI validation checklist for commit/reveal/claim flows and failure messaging in a live session.
- Indexer tests validating reconstruction from `RoundCreated`, `Stepped`, `Finalized`, `Claimed`.
- Deployment script tests (dry-run/fork) verifying expected addresses/config wiring.
- Replay artifact generation tests ensuring deterministic outputs from same inputs.
- Wallet transaction orchestration tests in deterministic `apps/web/lib/*` modules (provider mocked, no component-markup tests).

Exit criteria:
- Local end-to-end round from create -> claim is reproducible with deterministic checks.

### 17.6 Phase 5: Performance + Gas Regression TDD

Goals:
- Prevent silent degradation in gas/latency as features evolve.

Required tests:
- Foundry gas snapshot tests for critical methods (`commit`, `reveal`, `stepBatch`, `finalize`, `claim`).
- Benchmark tests for multiple `maxBatch` settings on Shape Sepolia.
- Regression thresholds: fail CI on configured % increase above baseline per critical path.
- Stress tests for max slot occupancy and long simulations (`maxGen`).

Exit criteria:
- Locked safe `maxBatch` backed by benchmark artifacts and enforced CI thresholds.

### 17.7 Phase 6: Release Gates and Ongoing Quality

Required merge gates:
- All tests green across packages.
- New feature code accompanied by tests in same change.
- Coverage floor per package (raise over time; no downward changes without explicit approval).
- Bug fixes include failing test that reproduces bug pre-fix.

Required pre-release checks:
- Full deterministic replay corpus pass.
- Fuzz/invariant suite pass with fixed seed + rotating seed job.
- Sepolia smoke suite pass on deployed contracts.
- Indexer reconciliation report shows zero accounting drift.

### 17.8 Failure-Mode-First Test Backlog (must be implemented early)

P0:
- Wrong commit preimage domain separation (`chainId`, `arena`, `player`) bypass attempts.
- Keeper payout over-claim via large `steps` requests.
- Claim double-spend/reentrancy attempts.
- Divergent TS/Solidity behavior at cylinder boundaries.

P1:
- Non-reveal forfeits and zero-winner edge routing.
- Draw payout correctness with uneven team participation.
- Slot contention and race conditions around commit deadlines.

P2:
- UI/indexer eventual consistency under reorg-like event ordering in local tests.
- Artifact generation determinism under worker retries.

P3:
- Long-run simulation drift and visual replay fidelity checks.

### 17.9 Immediate Testing Action Items (append to active execution queue)

[x] Add web bootstrap tests first (`apps/web`) for health route contract and board summary accounting.
[x] Initialize `apps/web` shadcn/ui baseline and install all registry `ui` components under `apps/web/components/ui`.
[x] Add Next.js-recommended flat ESLint baseline (`next/core-web-vitals` + `next/typescript`) with workspace lint scripts and zero-warning lint gate.
[x] Create failing tests first for pack/unpack, B3/S23, and Immigration majority rules.
[x] Add TS<->Solidity golden/parity suite with random-seed fuzz harness.
[x] Add round transition guard matrix tests with explicit revert expectations.
[x] Add payout/accounting invariants including dust and keeper shortfall handling.
[x] Add end-to-end local round test covering commit -> reveal -> step -> finalize -> claim.
[x] Add gas snapshot + regression threshold checks to CI and block regressions by default.
[x] Add aggregate/CI contract test execution (`forge test`) so Solidity regressions are caught outside package-local runs.

## 18. Implementation Standards Mandate (Docs-First)

Most implementation must meticulously follow official documentation and modern best-practice recommendations for the relevant tool/framework.

Required baselines:
- Contracts/security patterns: OpenZeppelin docs (`https://docs.openzeppelin.com/`).
- Solidity dev/testing workflows: Foundry guides (`https://www.getfoundry.sh/guides`) and Hardhat docs (`https://hardhat.org/docs/getting-started`).
- Web app architecture and APIs: Next.js docs (`https://nextjs.org/docs`).
- Monorepo pipelines/task graph conventions: Turborepo docs (`https://turborepo.dev/docs`).

Execution rules:
- Prefer official docs for the exact version in use over blog posts or forum snippets.
- When docs conflict or project constraints require deviation, document the decision and tradeoff in `plan.md` before or with implementation.
- Treat docs-alignment gaps as impact-ordered follow-ups (`P0`-`P3`) and track them in the active plan queue.

## 19. Progress Log

- 2026-02-13:
  - Completed P2.9 web wallet onboarding migration slice with strict TDD (`Red -> Green`):
    - Added failing tests first in `apps/web/test/wallet-onboarding.test.ts` for deterministic signup gating transitions (missing round config, disconnected wallet, wrong chain, ready state).
    - Added `apps/web/lib/wallet-onboarding.ts` to centralize connect/switch/ready transition logic for UI gating.
    - Added wagmi SSR provider wiring:
      - `apps/web/lib/wagmi-config.ts` for Shape Sepolia chain/config transport setup.
      - `apps/web/app/providers.tsx` for `WagmiProvider` + `QueryClientProvider`.
      - `apps/web/app/layout.tsx` now hydrates wagmi state from cookies via `cookieToInitialState`.
    - Refactored `apps/web/components/round-wallet-panel.tsx` signup path to wagmi hooks (`useAccount`, `useConnect`, `useSwitchChain`) with explicit chain gating before tx submission.
    - Updated `README.md` and `architecture.md` for the wagmi onboarding/runtime env expectations.
  - Completed P2.10 web tx-signing migration slice with strict TDD (`Red -> Green`):
    - Added failing tests first in `apps/web/test/wallet-signing.test.ts` for deterministic write-request shaping and wallet-error normalization.
    - Added `apps/web/lib/wallet-signing.ts` to build validated commit/reveal/claim write requests and map signing failures into stable UX messages.
    - Refactored `apps/web/components/round-wallet-panel.tsx` tx path to use wagmi/viem primitives:
      - `simulateContract` preflight before signing
      - `writeContract` for wallet signature submission
      - `waitForTransactionReceipt` confirmation status reporting
    - Added disconnected-wallet discovery hint when no injected connectors are available in-browser.
  - Completed P2.11 legacy wallet-submit shim cleanup slice:
    - Removed `apps/web/lib/wallet-journey.ts` provider-request shim now that wagmi-native signing is canonical.
    - Removed `apps/web/test/wallet-journey.test.ts` and kept deterministic signing coverage in `apps/web/test/wallet-signing.test.ts`.
    - Updated `architecture.md` test-coverage notes to match the current web test surface.
  - Completed P2.13 web join-flow + tx-feedback spec-gap slice with strict TDD (`Red -> Green`):
    - Added failing tests first:
      - `apps/web/test/wallet-ux.test.ts` for seed transform coverage (rotate/mirror/translate) and preset budget guarantees.
      - `apps/web/test/wallet-tx-feedback.test.ts` for explicit tx lifecycle feedback (`pending`, `sign`, `confirming`, `error`, `success`).
    - Implemented deterministic helpers:
      - `apps/web/lib/wallet-ux.ts` now includes seed presets + transform primitives.
      - `apps/web/lib/wallet-tx-feedback.ts` centralizes tx-stage messages and badge mapping.
    - Refactored `apps/web/components/round-wallet-panel.tsx`:
      - added seed preset/transform controls and budget progress meter.
      - added explicit tx status panel with staged visual states and tx-hash carry-through.
    - Updated `README.md` and `architecture.md` to document new join-flow + tx-feedback behavior.
  - Completed P3.1 keeper observability/operator-polish slice:
    - Added `packages/contracts/scripts/sepolia-keeper-status.ts` to read live Sepolia round state and emit deterministic keeper next-action recommendations from phase windows and terminal conditions.
    - Added utility coverage in `packages/contracts/scripts/sepolia-keeper-status.test.ts` for cast bool parsing and action recommendation branches (`wait-commit`, `begin-reveal`, `initialize`, `step-batch`, `finalize`, `claim`).
    - Wired root command `observe:sepolia:keeper` in `package.json`.
    - Updated `README.md` and `architecture.md` with keeper observability command/docs.
  - Completed P3.2 keeper runbook/operator playbook slice:
    - Added `packages/contracts/docs/keeper-runbook.md` with an explicit operator loop, transition call commands, and immediate failure-mode responses.
    - Linked the runbook from `README.md` and documented it in `architecture.md`.
    - Synced impact queue/status updates in Section 20 (`P3.2` complete).
  - Completed P3.3 keeper command-hint automation slice:
    - Extended `packages/contracts/scripts/sepolia-keeper-status.ts` to emit `recommendedCommand` for actionable transition phases.
    - Added command-builder tests in `packages/contracts/scripts/sepolia-keeper-status.test.ts` to prevent command-shape regressions.
    - Updated `README.md` and `architecture.md` to document the new machine-actionable output field.
  - Completed P1.4 Sepolia rollout automation slice:
    - Added `packages/contracts/scripts/sepolia-max-batch-rollout.ts` to run `deploy/address-resolve -> benchmark -> lock -> smoke` as one deterministic pipeline.
    - Added tests first in `packages/contracts/scripts/sepolia-max-batch-rollout.test.ts` for round-address normalization/selection and deploy decision guards.
    - Wired root command `rollout:sepolia:max-batch` in `package.json` and documented usage/flags in `README.md` and `architecture.md`.
    - Kept `P1.2` marked blocked; live execution still requires `SHAPE_SEPOLIA_RPC_URL`, `DEPLOYER_PRIVATE_KEY`, and deployable/reachable round context.
  - Completed P3.4 keeper tick automation slice:
    - Added `packages/contracts/scripts/sepolia-keeper-tick.ts` to run one keeper tick from observability output, with dry-run default and optional `--execute` transaction submission.
    - Added tests first in `packages/contracts/scripts/sepolia-keeper-tick.test.ts` for command argument derivation across executable/non-executable recommendation paths.
    - Wired root command `tick:sepolia:keeper` in `package.json`, then updated `README.md`, `packages/contracts/docs/keeper-runbook.md`, and `architecture.md`.
  - Completed P3.5 keeper loop automation slice:
    - Added `packages/contracts/scripts/sepolia-keeper-loop.ts` to run recurring keeper ticks with configurable interval and iteration bounds.
    - Added tests first in `packages/contracts/scripts/sepolia-keeper-loop.test.ts` for argument parsing and loop stop-decision behavior.
    - Wired root command `loop:sepolia:keeper` in `package.json`, then updated `README.md`, `packages/contracts/docs/keeper-runbook.md`, and `architecture.md`.
  - Validation:
    - `cd apps/web && bun run test` passed.
    - `cd apps/web && bun run lint` passed.
    - `cd apps/web && bun run build` passed.
    - `bun test packages/contracts/scripts/sepolia-max-batch-rollout.test.ts` passed.
    - `bun test packages/contracts/scripts/sepolia-keeper-tick.test.ts` passed.
    - `bun test packages/contracts/scripts/sepolia-keeper-loop.test.ts` passed.
    - `bun test packages/contracts/scripts/*.test.ts` passed.
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
    - `bun run lint:web` passed.
    - `cd apps/web && bun run build` passed.
- 2026-02-12:
  - Completed P2.8 web test-scope simplification + docs-alignment slice:
    - Removed `apps/web/test/ui-baseline.test.ts` (component-markup policy test).
    - Updated project policy/docs to keep Vitest focused on deterministic core logic/rules and validate UI behavior via live browser sessions.
  - Validation:
    - `cd apps/web && bun run test` passed.
    - `cd apps/web && bun run lint` passed.
    - `cd apps/web && bun run build` passed.
  - Completed P0.5 spec-complete finalize scoring slice with strict TDD (`Red -> Green`):
    - Added failing Foundry tests first in `packages/contracts/test/ConwayArenaRoundSimulation.t.sol` for weighted winner resolution and deterministic draw resolution under `3*population + 2*invasion`.
    - Implemented board-derived scoring outputs in `packages/contracts/src/ConwayArenaRound.sol`:
      - `finalBlueInvasion`, `finalRedInvasion`
      - `scoreBlue`, `scoreRed`
      - winner resolution now compares weighted scores when neither team is extinct.
    - Updated `packages/contracts/test/ConwayArenaRoundWinnerPayout.t.sol` draw fixture vectors so draw payout behavior remains deterministic under weighted scoring.
    - Refreshed the contract gas snapshot baseline after scoring-field additions.
  - Validation:
    - `cd packages/contracts && HOME=/tmp FOUNDRY_CACHE_ROOT=/tmp/foundry-cache forge test --offline --match-path test/ConwayArenaRoundSimulation.t.sol` passed.
    - `cd packages/contracts && HOME=/tmp FOUNDRY_CACHE_ROOT=/tmp/foundry-cache forge test --offline` passed.
    - `bun run test:contracts:gas` passed.
    - `bun run test` passed.
  - Re-scoped web test runner and browser-validation workflow per operator guidance:
    - Removed temporary Testing Library/Happy DOM dependencies and deleted the corresponding panel interaction test.
    - Migrated `apps/web` tests to Vitest:
      - updated test imports in `apps/web/test/*.test.ts` from `bun:test` to `vitest`
      - added `apps/web/vitest.config.ts` with project-root alias mapping for `@/*`
      - updated scripts: root `test:web` now runs `cd apps/web && bun run test`, and `apps/web` `test` now runs `vitest run`
    - Performed real-browser interaction validation by running `apps/web` locally and exercising wallet UI flows in a live browser session (connect, team/slot selection, reveal submission, rejection path).
  - Validation:
    - `cd apps/web && bun run test` passed.
    - `bun run lint:web` passed.
    - `cd apps/web && bun run build` passed.
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
  - Completed P2.6 provider-mocked wallet transition test slice with strict TDD (`Red -> Green`):
    - Added failing integration tests first in `apps/web/test/wallet-journey.test.ts` covering:
      - chain-switch + commit submission path
      - reveal submission when already on Shape Sepolia
      - provider failure propagation for optimistic UI error handling
    - Implemented reusable submission orchestrator in `apps/web/lib/wallet-journey.ts`.
    - Refactored `apps/web/components/round-wallet-panel.tsx` to delegate transaction orchestration to the tested module.
  - Validation:
    - `bun test apps/web/test` passed.
    - `bun run lint:web` passed.
    - `cd apps/web && bun run build` passed.
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
  - Completed P2.5 web integration-test coverage slice with strict TDD (`Red -> Green`):
    - Added failing tests first:
      - `apps/web/test/wallet-submit.test.ts` for commit/reveal/claim failure-path validation (territory, budget, salt shape)
      - `apps/web/test/round-live-consistency.test.ts` for stale-snapshot + reconciliation-status consistency on `/api/round/live`
    - Implemented reusable wallet submission validator in `apps/web/lib/wallet-submit.ts` and wired `apps/web/components/round-wallet-panel.tsx` to consume it.
    - Added route/UI-facing wallet/seed/slot helper test coverage to lock deterministic UX invariants.
  - Validation:
    - `bun test apps/web/test` passed.
    - `bun run lint:web` passed.
    - `cd apps/web && bun run build` passed.
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
  - Completed P2.4 wallet UX expansion slice with strict TDD (`Red -> Green`):
    - Added failing tests first in `apps/web/test/wallet-ux.test.ts` for:
      - seed bit toggling/inspection semantics
      - slot-index grid mapping
      - team-territory slot enforcement
    - Implemented UX primitives in `apps/web/lib/wallet-ux.ts` and integrated into `apps/web/components/round-wallet-panel.tsx`:
      - team-aware slot picker (64-slot grid with territory guardrails)
      - 8x8 seed editor with budget enforcement (`<= 12` live cells)
      - optimistic pending-submit feedback during commit/reveal/claim sends
  - Validation:
    - `bun test apps/web/test` passed.
    - `bun run lint:web` passed.
    - `cd apps/web && bun run build` passed.
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
  - Completed P2.3 indexer cursor resume + confirmation-depth/reorg handling slice with strict TDD (`Red -> Green`):
    - Added failing tests first:
      - `packages/indexer/test/sync-window.test.ts` (cursor window derivation + confirmation-depth clamping)
      - `packages/indexer/test/round-sync.test.ts` (incremental merge + overlap replacement for reorg-safe refresh)
    - Extended indexer ingestion/read model:
      - `buildRoundReadModel` now supports incremental merge via `previousModel` and persists full sorted event streams for resumable sync.
      - Added overlap-pruning merge semantics so reprocessed windows replace prior events in the overlap range.
    - Upgraded sync CLI in `packages/indexer/src/sync-round-read-model.ts`:
      - persisted cursor file (`round-read-model.cursor.json`)
      - `--confirmations` and `--reorg-lookback` controls
      - cursor-aware sync window selection and overlap replay.
  - Validation:
    - `bun test packages/indexer/test` passed.
  - Completed P2.2 web wallet journey + realtime spectator state slice with strict TDD (`Red -> Green`):
    - Added failing tests first:
      - `apps/web/test/round-tx.test.ts` (commit preimage/domain-separation hash + calldata encoding for commit/reveal/claim)
      - `apps/web/test/round-live-route.test.ts` (normalized persisted read-model API contract + unavailable-model failure path)
    - Implemented wallet + live-state surfaces:
      - `apps/web/components/round-wallet-panel.tsx` (browser-wallet connect + commit/reveal/claim tx submission)
      - `apps/web/components/round-live-panel.tsx` (polling spectator view backed by persisted read model)
      - `apps/web/app/api/round/live/route.ts` + `apps/web/lib/round-live.ts`
      - `apps/web/lib/round-tx.ts` (hash/calldata builders)
      - `apps/web/app/page.tsx` integration
    - Added web dependency wiring for `viem` in `apps/web/package.json`.
  - Validation:
    - `bun test apps/web/test` passed.
    - `bun run lint:web` passed.
    - `cd apps/web && bun run build` passed.
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
  - Completed P2.1 chain-ingesting indexer pipeline + persisted read-model slice with strict TDD (`Red -> Green`):
    - Added failing tests first in `packages/indexer/test/ingest-round-read-model.test.ts` for:
      - deterministic chain-state + event ingestion into a round read model
      - pending-finalize reconciliation behavior
      - fail-noisy reconciliation divergence (`keeper paid mismatch`)
    - Implemented viem-backed ingestion and read-model assembly:
      - `packages/indexer/src/ingest-round-read-model.ts`
      - `packages/indexer/src/round-read-model-store.ts`
      - `packages/indexer/src/sync-round-read-model.ts`
    - Added command wiring for operator sync runs:
      - root `indexer:sync:round`
      - package `packages/indexer` script `sync:round`
    - Updated docs:
      - `README.md` indexer sync command
      - `architecture.md` indexer ingestion/read-model architecture section
  - Validation:
    - `bun test packages/indexer/test` passed.
  - Completed P0.3 deterministic terminal-resolution hardening slice with strict TDD (`Red -> Green`):
    - Removed mutable `setExtinction` path from `packages/contracts/src/ConwayArenaRound.sol`.
    - `initialize()` now refreshes board status after seed materialization so extinction state is board-derived from first Sim tick.
    - `finalize()` now always refreshes board status and only allows early terminal transition when board-derived extinction is true.
    - Updated lifecycle/accounting/winner-claim tests to remove helper overrides and assert terminal behavior via real board state:
      - `packages/contracts/test/ConwayArenaRoundWinnerPayout.t.sol`
      - `packages/contracts/test/ConwayArenaRoundClaimSafety.t.sol`
      - `packages/contracts/test/ConwayArenaRoundAccounting.t.sol`
      - `packages/contracts/test/ConwayArenaRoundEvents.t.sol`
      - `packages/contracts/test/ConwayArenaRoundStateMachine.t.sol`
    - Refreshed Solidity gas baseline snapshot at `packages/contracts/.gas-snapshot`.
  - Validation:
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
    - `bun run lint:web` passed.
    - `cd apps/web && bun run build` passed.
  - Completed P0.4 accounting-invariant expansion slice with strict TDD (`Red -> Green`):
    - Added full simulation-backed invariant coverage for mixed claim ordering and keeper-withdraw interplay in `packages/contracts/test/ConwayArenaRoundAccounting.t.sol`.
    - Added partial-claim invariant coverage proving conservation while winner pool remains partially unclaimed.
    - Added reusable accounting conservation helper assertion:
      - `winnerPool + keeperPoolRemaining + winnerPaid + keeperPaid + treasuryDust == totalFunded`
      - `winnerPaid + keeperPaid + treasuryDust <= totalFunded`
  - Validation:
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
    - `bun run lint:web` passed.
    - `cd apps/web && bun run build` passed.
  - Completed P1.1 deployment/verification scaffold slice:
    - Added Hardhat workspace scaffold in `packages/contracts`:
      - `hardhat.config.ts` with Shape Sepolia/Mainnet network wiring via `SHAPE_SEPOLIA_RPC_URL`, `SHAPE_MAINNET_RPC_URL`, and `DEPLOYER_PRIVATE_KEY`.
      - `ignition/modules/ConwayArenaRound.ts` and deterministic parameters at `ignition/parameters/shape-sepolia.json`.
      - verification/address tooling:
        - `packages/contracts/scripts/verify-shape-sepolia.ts`
        - `packages/contracts/scripts/show-shape-sepolia-round.ts`
    - Added deployment-address utility + tests:
      - `packages/contracts/scripts/ignition-address.ts`
      - `packages/contracts/scripts/ignition-address.test.ts`
    - Added root command wiring:
      - `contracts:hardhat:compile`
      - `deploy:contracts:shape-sepolia`
      - `verify:contracts:shape-sepolia`
      - `show:contracts:shape-sepolia:round`
    - Updated `README.md` with deploy/verify/address extraction commands and required env variables.
  - Validation:
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
    - `bun run lint:web` passed.
    - `cd apps/web && bun run build` passed.
    - `bun run contracts:hardhat:compile` currently fails in this sandbox with Hardhat `HHE905` (compiler list download requires internet access).
  - Advanced P1.2 benchmark lock pipeline while live Sepolia execution remains environment-blocked:
    - Added lock utility + tests:
      - `packages/contracts/scripts/lock-max-batch-from-benchmark.ts`
      - `packages/contracts/scripts/lock-max-batch-from-benchmark.test.ts`
    - Added command wiring:
      - `lock:sepolia:max-batch`
      - `benchmark:sepolia:max-batch:lock`
      - `packages/contracts` script alias `lock:max-batch:shape-sepolia`
    - Updated `README.md` with benchmark-lock workflow commands.
  - Validation:
    - `bun run deploy:contracts:shape-sepolia` failed with Hardhat `HHE7` (`SHAPE_SEPOLIA_RPC_URL` missing in current environment).
    - `bun run benchmark:sepolia:max-batch` failed with `SHAPE_SEPOLIA_RPC_URL is required`.
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
    - `bun run lint:web` passed.
    - `cd apps/web && bun run build` passed.
  - Completed P1.3 Sepolia smoke/release gate slice:
    - Added Sepolia smoke command + tests:
      - `packages/contracts/scripts/sepolia-smoke-round.ts`
      - `packages/contracts/scripts/sepolia-smoke-round.test.ts`
    - Added root command wiring:
      - `smoke:sepolia:round`
      - `release:gate:sepolia`
      - `packages/contracts` script alias `smoke:shape-sepolia:round`
    - Updated `README.md` and section 20.4 validation gates with required env/config for smoke and release gate execution.
  - Validation:
    - `bun run smoke:sepolia:round` failed with `--rpc or SHAPE_SEPOLIA_RPC_URL is required` (expected in current environment without Sepolia env).
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
    - `bun run lint:web` passed.
    - `cd apps/web && bun run build` passed.
  - Performed docs + implementation audit and aligned closeout tracking with a new readiness checklist + impact-ordered Sepolia plan in section 20.
  - Latest local validation in this workspace:
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
    - `bun run lint:web` passed.
    - `cd apps/web && bun run build` passed.
  - Sepolia benchmark lock remains blocked in this environment due to missing `ROUND_ADDRESS` (RPC is now configured and reachable).
  - Validation:
    - `SHAPE_SEPOLIA_RPC_URL=<configured> bun run benchmark:sepolia:max-batch` failed with `--round or ROUND_ADDRESS is required`.
  - Completed P0 simulation-foundation slice with strict TDD (`Red -> Green`):
    - Added failing simulation behavior tests in `packages/contracts/test/ConwayArenaRoundSimulation.t.sol` for:
      - revealed-seed materialization into board rows at `initialize`
      - `stepBatch`-driven board evolution via Conway engine
      - board-derived winner resolution at max generation without manual extinction flags
    - Extended `packages/contracts/src/ConwayArenaRound.sol` with:
      - 64x64 board state storage (`blueRows`, `redRows`) and final population snapshots
      - deterministic seed-to-board placement on `initialize`
      - engine-backed stepping in `stepBatch` using `ConwayEngine.step`
      - board-status refresh and population-aware winner resolution at max-gen finalize
    - Updated draw payout fixture in `packages/contracts/test/ConwayArenaRoundWinnerPayout.t.sol` to a stable symmetric draw seed pair under real simulation.
    - Refreshed Solidity gas baseline snapshot at `packages/contracts/.gas-snapshot`.
  - Validation:
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
    - `bun run lint:web` passed.
    - `cd apps/web && bun run build` passed.
  - Completed P0 funding-invariant hardening for accounting configuration:
    - Added `InsufficientRoundBalance(required, available)` guard in `configureAccounting`.
    - Added failing test and coverage updates in `packages/contracts/test/ConwayArenaRoundAccounting.t.sol`.
    - Updated accounting-enabled tests to fund contract balance before configuration where required:
      - `packages/contracts/test/ConwayArenaRoundEvents.t.sol`
      - `packages/contracts/test/ConwayArenaRoundE2E.t.sol`
      - `packages/contracts/test/ConwayArenaRoundGas.t.sol`
    - Refreshed Solidity gas baseline snapshot at `packages/contracts/.gas-snapshot`.
  - Validation:
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
  - Completed P0 transfer-path reentrancy hardening slice:
    - Added contract-level non-reentrancy guard to `claim(uint8)` and `withdrawKeeperCredit()` in `packages/contracts/src/ConwayArenaRound.sol`.
    - Added failing probe test `packages/contracts/test/ConwayArenaRoundReentrancy.t.sol` that attempts cross-function reentrancy from claim payout fallback into keeper-withdraw path.
    - Probe now confirms reentrant withdraw is blocked.
    - Refreshed Solidity gas baseline snapshot at `packages/contracts/.gas-snapshot`.
  - Validation:
    - `cd packages/contracts && HOME=/tmp FOUNDRY_CACHE_ROOT=/tmp/foundry-cache forge test --match-path test/ConwayArenaRoundReentrancy.t.sol` passed.
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
  - Completed P0 settlement-safety hardening for accounting rounds:
    - Disabled `settleWinnerClaims` for accounting-configured rounds in `ConwayArenaRound` to prevent manual settlement grief against transfer-based claims.
    - Added finalize-time zero-eligible auto-routing (`winnerPool -> treasuryDust`) and payout lock.
    - Added/updated tests:
      - `packages/contracts/test/ConwayArenaRoundAccounting.t.sol`:
        - manual settlement disable guard
        - winner claim accounting invariant with transfer path
        - zero-eligible finalize routing assertion
      - `packages/contracts/test/ConwayArenaRoundEvents.t.sol`:
        - finalized event expectations aligned with zero-eligible routing
        - legacy non-accounting settlement event path retained
      - `packages/contracts/test/ConwayArenaRoundE2E.t.sol`:
        - end-state accounting reconciles with undistributed `winnerPool` when no slot claims occur
    - Refreshed Solidity gas baseline snapshot at `packages/contracts/.gas-snapshot`.
  - Validation:
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
  - Completed P1 winner payout transfer plumbing slice with strict TDD (`Red -> Green`):
    - Added failing tests in `packages/contracts/test/ConwayArenaRoundWinnerPayout.t.sol` for:
      - equal-share winner payout transfers across winning revealed slots
      - draw payout splitting across both teams
      - non-winning revealed claims returning zero while preserving one-claim-only semantics
    - Extended `packages/contracts/src/ConwayArenaRound.sol` with:
      - finalize-time winner side resolution (`winnerTeam`)
      - revealed team counters for eligibility accounting
      - lazy payout lock + deterministic `payoutPerClaim` allocation (dust to treasury)
      - transfer-capable `claim(uint8)` returning payout amount for eligible slots
    - Refreshed Solidity gas baseline snapshot at `packages/contracts/.gas-snapshot`.
  - Validation:
    - `cd packages/contracts && HOME=/tmp FOUNDRY_CACHE_ROOT=/tmp/foundry-cache forge test --match-path test/ConwayArenaRoundWinnerPayout.t.sol` passed.
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
  - Attempted to execute Sepolia benchmark lock step in this environment; still blocked by missing runtime inputs:
    - `SHAPE_SEPOLIA_RPC_URL`
    - `ROUND_ADDRESS` (deployed round in `Sim` phase)
  - Validation:
    - `bun run benchmark:sepolia:max-batch` failed with `SHAPE_SEPOLIA_RPC_URL is required`.
  - Completed P1 keeper reward pull-withdraw payout plumbing slice with strict TDD (`Red -> Green`):
    - Added failing tests in `packages/contracts/test/ConwayArenaRoundKeeperWithdraw.t.sol` for:
      - successful keeper credit withdrawal transfer + credit reset
      - no-credit revert path
    - Extended `packages/contracts/src/ConwayArenaRound.sol` with:
      - `withdrawKeeperCredit()` pull-payment function
      - payable `receive()` for native-fund intake
      - `NoKeeperCredit` / `TransferFailed` errors and `KeeperCreditWithdrawn` event
    - Refreshed Solidity gas baseline snapshot at `packages/contracts/.gas-snapshot`.
  - Validation:
    - `cd packages/contracts && HOME=/tmp FOUNDRY_CACHE_ROOT=/tmp/foundry-cache forge test --match-path test/ConwayArenaRoundKeeperWithdraw.t.sol` passed.
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
  - Completed P1 one-claim-only slot safety slice with strict TDD (`Red -> Green`):
    - Added failing tests in `packages/contracts/test/ConwayArenaRoundClaimSafety.t.sol` covering:
      - only revealed slot owner can claim
      - one-claim-only idempotency per slot
      - unrevealed slots cannot claim
    - Extended `packages/contracts/src/ConwayArenaRound.sol` with payload-aware `claim(uint8)`:
      - slot existence/reveal/owner guards
      - per-slot claimed marker (`slot.claimed`) with explicit revert on replay
    - Updated slot-structure assertions in `packages/contracts/test/ConwayArenaRoundCommitReveal.t.sol`.
    - Refreshed Solidity gas baseline snapshot at `packages/contracts/.gas-snapshot`.
  - Validation:
    - `cd packages/contracts && HOME=/tmp FOUNDRY_CACHE_ROOT=/tmp/foundry-cache forge test --match-path test/ConwayArenaRoundClaimSafety.t.sol` passed.
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
  - Completed P1 commit/reveal payload-validation guard slice with strict TDD (`Red -> Green`):
    - Added failing tests in `packages/contracts/test/ConwayArenaRoundCommitReveal.t.sol` covering:
      - slot reservation and one-reserved-slot-per-address safety
      - team/slot territory enforcement
      - reveal sender ownership checks
      - reveal commit-hash preimage verification
      - seed budget (`<= 12`) enforcement and double-reveal prevention
    - Extended `packages/contracts/src/ConwayArenaRound.sol` with minimal slot payload state + guard logic:
      - overloaded payload-aware `commit(uint8,uint8,bytes32)` and `reveal(uint256,uint8,uint8,uint64,bytes32)`
      - `slots` + `hasReservedSlot` tracking
      - territory/slot/team validation, commit-hash verification, and seed popcount budget checks
    - Updated no-arg guard matrix tests for overload-safe call encoding in `packages/contracts/test/ConwayArenaRoundStateMachine.t.sol`.
    - Refreshed Solidity gas baseline snapshot at `packages/contracts/.gas-snapshot`.
  - Validation:
    - `cd packages/contracts && HOME=/tmp FOUNDRY_CACHE_ROOT=/tmp/foundry-cache forge test --match-path test/ConwayArenaRoundCommitReveal.t.sol` passed.
    - `bun run test` passed.
    - `bun run test:contracts:gas` passed.
  - Completed P0 commit preimage domain-separation hardening slice:
    - Added `hashCommit(roundId, player, team, slotIndex, seedBits, salt)` to `packages/contracts/src/ConwayArenaRound.sol` binding `block.chainid` and `address(this)` in the commit preimage.
    - Added `packages/contracts/test/ConwayArenaRoundCommitHash.t.sol` covering:
      - positive hash equivalence for `keccak256(abi.encode(roundId, chainId, arena, player, ...))`
      - replay-safety signal that player changes alter the commit hash.
  - Validation:
    - `cd packages/contracts && HOME=/tmp FOUNDRY_CACHE_ROOT=/tmp/foundry-cache forge test --offline --match-path test/ConwayArenaRoundCommitHash.t.sol` passed.
  - Started Sepolia `maxBatch` benchmark automation (execution pending RPC/deployed round inputs):
    - Added `packages/contracts/scripts/max-batch-benchmark.ts` to measure `stepBatch(uint16)` via `cast estimate` and compute lock recommendation from configurable gas headroom.
    - Added test-first utility coverage in `packages/contracts/scripts/max-batch-benchmark.test.ts` for output parsing and lock selection thresholds.
    - Wired root scripts:
      - `test:contracts:scripts` for benchmark utility tests.
      - `benchmark:sepolia:max-batch` for live measurement artifact generation.
  - Validation:
    - `bun test packages/contracts/scripts/max-batch-benchmark.test.ts` passed.
  - Completed indexer reconciliation checks against accounting-critical lifecycle events:
    - Added `Stepped`, `Finalized`, and `Claimed` events to `packages/contracts/src/ConwayArenaRound.sol`.
    - Added event emission tests in `packages/contracts/test/ConwayArenaRoundEvents.t.sol`.
    - Added `packages/indexer/src/reconcile-round-events.ts` with deterministic reconciliation logic and failure conditions.
    - Added `packages/indexer/test/reconcile-round-events.test.ts` covering happy-path reconciliation and mismatch/missing-event failures.
    - Added `packages/indexer/package.json` and wired root aggregate tests to include `test:indexer`.
  - Validation:
    - `bun test packages/indexer/test` passed.
    - `cd packages/contracts && HOME=/tmp FOUNDRY_CACHE_ROOT=/tmp/foundry-cache forge test --offline --match-path test/ConwayArenaRoundEvents.t.sol` passed.
  - Added aggregate Solidity test execution in shared local/CI gates:
    - Root `bun run test` now executes `test:sim`, `test:web`, and `test:contracts` (Foundry suite included).
    - Updated `.github/workflows/contracts-gas.yml` to run `forge test` before gas snapshot checks.
  - Validation:
    - `bun run test` passed, including `forge test`.
  - Added gas regression gates for Solidity lifecycle paths:
    - Added `packages/contracts/test/ConwayArenaRoundGas.t.sol` with dedicated gas checkpoints for `commit`, `reveal`, `stepBatch`, `finalize`, and `claim`.
    - Generated baseline `packages/contracts/.gas-snapshot`.
    - Added CI workflow `.github/workflows/contracts-gas.yml` to run `forge snapshot --match-test testGas --check` on PRs/pushes.
    - Added root script `test:contracts:gas` and documented usage in `README.md`.
  - Validation:
    - `bun run test:contracts:gas` passed.
  - Added local end-to-end round lifecycle integration test:
    - `packages/contracts/test/ConwayArenaRoundE2E.t.sol` now covers `commit -> reveal -> step -> finalize -> claim` with accounting reconciliation assertion.
  - Validation:
    - `cd packages/contracts && HOME=/tmp FOUNDRY_CACHE_ROOT=/tmp/foundry-cache forge test -q` passed (compile + tests).
  - Completed payout/accounting invariant TDD slice on round contract:
    - Added failing accounting tests in `packages/contracts/test/ConwayArenaRoundAccounting.t.sol` for:
      - keeper shortfall clamp under over-requested `stepBatch` calls
      - post-claim accounting invariant: `winnerPaid + keeperPaid + treasuryDust <= totalFunded`
      - zero-eligible-winner dust routing
    - Extended `packages/contracts/src/ConwayArenaRound.sol` with minimal accounting state and logic:
      - funding/reward config (`configureAccounting`)
      - keeper reward clamping and credit accounting inside `stepBatch`
      - finalize-time keeper remainder rollover into winner pool
      - claim settlement helper with dust routing (`settleWinnerClaims`)
  - Validation:
    - `cd packages/contracts && HOME=/tmp FOUNDRY_CACHE_ROOT=/tmp/foundry-cache forge test` passed (28/28).
  - Completed Phase 3 guard-matrix TDD slice for round lifecycle transitions:
    - Added failing state-machine tests with explicit revert-selector assertions in `packages/contracts/test/ConwayArenaRoundStateMachine.t.sol`.
    - Implemented minimal lifecycle contract in `packages/contracts/src/ConwayArenaRound.sol` with phase/time guards for `commit`, `beginReveal`, `reveal`, `initialize`, `stepBatch`, `finalize`, and `claim`.
    - Included `stepBatch` clamp behavior (`min(requestedSteps, maxBatch, maxGen - gen)`) and terminal-only finalize guard.
  - Validation:
    - `cd packages/contracts && HOME=/tmp FOUNDRY_CACHE_ROOT=/tmp/foundry-cache forge test -q` passed (compile + tests).
  - Renamed `game-rules.md` -> `concept.md` and reworked it into a user-facing concept doc:
    - Added a deeper Conway’s Game of Life concept section (emergence, pattern language, strategic intuition).
    - Structured the second half as player-facing Conway Arena rules (round flow, participation, winning, fairness).
    - Kept technical defaults/tuning values in `plan.md` to avoid spec duplication.
  - Added implementation-aligned architecture and rules documentation:
    - `architecture.md` captures current package boundaries, execution paths, invariants, and planned-but-not-yet-implemented surfaces.
    - Initial rules doc was later superseded by `concept.md` for user-facing communication.
  - Unblocked Foundry parity suite by removing Solidity stack-depth pressure in engine and reference test helpers.
    - Refactored neighbor-count loops into helper functions in `packages/contracts/src/ConwayEngine.sol` and `packages/contracts/test/ConwayEngineParity.t.sol` (no rules/topology behavior changes).
  - Validation:
    - `cd packages/contracts && HOME=/tmp FOUNDRY_CACHE_ROOT=/tmp/foundry-cache forge test -vv` passed (8/8).
    - `bun test` passed (16/16).
  - Committed and pushed web bootstrap + plan-sync changes to `main` (`dcda349`).
  - Committed and pushed shadcn/ui baseline + full UI component install to `main` (`ad0b1ce`).
  - Committed and pushed Next.js lint baseline + scaffold hardening to `main` (`4a154fa`).
  - Initialized shadcn/ui in `apps/web` and installed all current `registry:ui` components into `apps/web/components/ui`.
    - Note: `shadcn add --all` failed due upstream registry lookup for missing `new-york/combobox.json`; used explicit `registry:ui` enumeration from `shadcn list @shadcn` as a deterministic workaround.
  - Added project-level UI policy to `AGENTS.md`:
    - `apps/web` must derive UI elements from `apps/web/components/ui` and use out-of-box shadcn styles while final UI direction is unsettled.
  - Aligned landing page scaffold with shadcn/ui primitives (`Badge`, `Card`, `Separator`) and removed custom non-shadcn CSS blocks from `apps/web/app/globals.css`.
  - Validation:
    - `bun test apps/web/test` passed.
    - `bun test` passed.
    - `cd apps/web && bun run build` passed.
  - Hardened web scaffold against current Next.js/Tailwind lint/build expectations:
    - Added flat ESLint config in `apps/web/eslint.config.mjs` extending `next/core-web-vitals` and `next/typescript`.
    - Added lint scripts:
      - root: `lint`, `lint:web`
      - web: `lint`, `lint:fix`
    - Added required ESLint plugin dependencies for Bun workspace resolution and pinned `@next/eslint-plugin-next` to match Next version.
    - Fixed shadcn-generated lint edge cases:
      - Replaced impure `Math.random()` usage in `apps/web/components/ui/sidebar.tsx` with stable `useId`-derived width.
      - Simplified `apps/web/hooks/use-toast.ts` action typing and corrected effect dependency to avoid listener re-registration.
  - Validation:
    - `cd apps/web && bun run lint` passed.
    - `cd apps/web && bun run build` passed.
    - `bun test` passed.
- 2026-02-11:
  - Added docs-first implementation standards mandate to `plan.md` and `AGENTS.md` with explicit OpenZeppelin, Foundry, Hardhat, Next.js, and Turborepo baselines.
  - Completed first immediate testing action item with strict TDD (`Red -> Green`):
    - Added failing tests for pack/unpack, B3/S23 oscillator behavior, and Immigration majority color births in `packages/sim/test/engine.test.ts`.
    - Implemented minimal simulation engine primitives in `packages/sim/src/engine.ts` to make those tests pass.
  - Added repository-level `AGENTS.md` requiring progress tracking and docs synchronization on every feature change.
  - Completed second immediate testing action item:
    - Added shared golden vectors at `fixtures/engine/parity.v1.json`.
    - Added TS parity suite + deterministic random-seed fuzz harness in `packages/sim/test/parity.test.ts`.
    - Added Solidity parity + deterministic seed fuzz tests in `packages/contracts/test/ConwayEngineParity.t.sol`.
  - Completed topology edge-case parity hardening:
    - Added hard-X-edge/no-wrap and seam-wrapped Immigration majority vectors to `fixtures/engine/parity.v1.json`.
    - Added matching Solidity vector tests in `packages/contracts/test/ConwayEngineParity.t.sol` to prevent TS/Solidity divergence at cylinder boundaries.
  - Started Phase A web implementation with strict TDD (`Red -> Green`) for an atomic `P1` bootstrap slice:
    - Added failing tests for web health route and board-summary accounting in `apps/web/test/health-route.test.ts` and `apps/web/test/board-summary.test.ts`.
    - Implemented minimal web primitives to satisfy tests:
      - `apps/web/app/api/health/route.ts` (`GET` route handler contract)
      - `apps/web/lib/board-summary.ts` (board population accounting + overlap/width invariants)
      - `apps/web/app/layout.tsx`, `apps/web/app/page.tsx`, `apps/web/app/globals.css` (initial spectator shell)
    - Added web workspace bootstrap files:
      - `apps/web/package.json`, `apps/web/tsconfig.json`, `apps/web/next.config.ts`, `apps/web/next-env.d.ts`
    - Updated workspace/test docs:
      - Root workspaces/scripts in `package.json` now include `apps/*` and `test:web`.
      - `README.md` now documents web package scope and web test command.
    - Validation:
      - `bun test apps/web/test` passed (4 tests, 0 failures).
      - `bun test` passed (16 tests, 0 failures).

## 20. Readiness Checklist and Sepolia Closeout Plan (2026-02-12)

### 20.1 Phase Checklist (Spec vs Current Workspace)

- Phase A: Prototype the fun (offchain-first)
  - Status: PARTIAL
  - Done: TS engine primitives + parity tests, web scaffold, health route, board summary utilities.
  - Missing to hit deliverable: fully playable offchain prototype (seed editor, local full-round interaction flow, replay UX).
- Phase B: Solidity engine (Foundry-first)
  - Status: PARTIAL
  - Done: one-generation immigration engine with deterministic vector/fuzz parity coverage.
  - Missing to fully match plan intent: explicit Solidity pack/unpack utilities as first-class tested helpers.
- Phase C: Round manager contract
  - Status: PARTIAL
  - Done: phase guards, commit/reveal payload checks, slot ownership/idempotency, 64x64 board seed materialization, engine-backed `stepBatch`, weighted board-derived max-gen winner resolution (`3*population + 2*invasion`), accounting clamps, transfer-capable keeper/winner claim paths, event and gas regression tests.
  - Missing to satisfy "playable on local + Shape Sepolia":
    - keep gas envelope acceptable after simulation integration and lock Sepolia-proven batch thresholds
- Phase D: Deployments and scripts (Hardhat + viem)
  - Status: PARTIAL
  - Done: Hardhat + viem + Ignition scaffold with Shape Sepolia/Mainnet network wiring, deterministic module parameters, and deployment-address/verification utility scripts.
  - Missing: live Sepolia deploy execution, benchmark artifact capture, and measured `maxBatch` lock on deployed round.
- Phase E: Indexer + production UI
  - Status: PARTIAL
  - Done: deterministic reconciliation utility + tests for accounting-critical events, viem-backed chain ingestion + persisted round read-model sync tooling, cursor/reorg-aware incremental sync, baseline wallet/realtime spectator web surfaces, and keeper observability status command for live Sepolia rounds.
  - Missing: replay production polish and dedicated browser interaction automation harness.
- Phase F: Shape-native features
  - Status: NOT STARTED

### 20.2 Impact-Ordered Priorities

- P0:
  - Keep transfer paths explicitly reentrancy-safe after simulation integration.
- P1:
  - Execute Sepolia benchmark artifact run and lock `maxBatch` from measured thresholds.
  - Add Sepolia smoke checks for `commit -> reveal -> sim -> finalize -> claim`.
  - Add one-command rollout path so benchmark+lock execution is deterministic once env/deploy credentials are present.
- P2:
  - Completed for current web wallet UX scope: wagmi SSR onboarding + chain-gated tx signing/receipt flow + join-flow seed presets/transforms + explicit tx lifecycle UI states.
  - Follow-up: run live-browser validation pass for the updated wagmi signing flow (connect, switch chain, commit/reveal/claim, rejection path).
  - Follow-up: close remaining frontend spec gaps (canvas live board/animation, participant + keeper feed, end screen flow).
- P3:
  - Operator polish is in progress (keeper observability + runbook + command hints + keeper tick + keeper loop); remaining work is optional Shape-native features (Gasback/Stack/VRF).

### 20.3 Atomic Action Queue

[x] P0.1 Write failing Foundry tests for seed materialization, simulation stepping, and board-derived finalize scoring.
[x] P0.2 Implement board-state storage + `initialize` seed placement + `stepBatch` board progression with bounded write strategy.
[x] P0.3 Replace mutable terminal-resolution helpers with deterministic board-derived terminal checks in production flow.
[x] P0.4 Extend accounting/winner-claim invariants to cover full simulation-backed lifecycle and mixed claim ordering.
[x] P0.5 Extend finalize to emit/track weighted scoring outputs (final population + invasion) and resolve winner by score when no extinction occurs.
[x] P1.1 Add Hardhat + viem deployment/verification scaffold for Shape Sepolia and deterministic config wiring.
[ ] P1.2 Deploy round to Sepolia, run `benchmark:sepolia:max-batch`, persist artifact, and lock `maxBatch` (blocked pending `SHAPE_SEPOLIA_RPC_URL`, `DEPLOYER_PRIVATE_KEY`, and deployed `ROUND_ADDRESS`).
[x] P1.3 Add Sepolia smoke command and release gate documenting required env/config.
[x] P1.4 Add single-command rollout pipeline (`deploy/address-resolve -> benchmark -> lock -> smoke`) to reduce operator drift.
[x] P2.1 Implement chain-ingesting indexer pipeline and persisted round read model.
[x] P2.2 Implement web wallet journey for commit/reveal/claim + realtime spectator state.
[x] P2.3 Add indexer cursor resume + confirmation-depth reorg handling.
[x] P2.4 Expand wallet UX with slot picker, seed editor, and optimistic reservation/reveal feedback.
[x] P2.5 Add web integration tests covering commit/reveal/claim failure states and route-driven spectator consistency.
[x] P2.6 Add provider-mocked browser end-to-end tests for commit/reveal/claim success/failure transitions.
[x] P2.7 Validate wallet UI action sequencing in a live browser session with a mocked provider (connect, slot/team selection, reveal submit, rejection path), while keeping code-level coverage in Vitest.
[x] P2.9 Migrate web wallet signup flow to wagmi SSR providers with deterministic onboarding-state gating and explicit Shape Sepolia chain switch UX.
[x] P2.10 Migrate web tx signing flow to wagmi/viem contract-write + receipt-confirmation primitives with deterministic status-state tests.
[x] P2.11 Remove legacy provider-request wallet-submit shim/tests now that wagmi-native signing is canonical.
[x] P2.13 Add deterministic seed presets/transforms and explicit tx lifecycle feedback states (`pending`, `sign`, `confirming`, `error`, `success`) to the wallet join/signing UI.
[ ] P2.12 Validate updated wagmi wallet UI action sequencing in a live browser session (connect, chain switch, commit/reveal/claim, rejection path), while keeping code-level coverage in Vitest.
[ ] P2.14 Add spectator canvas board rendering + checkpoint animation and expose participant/keeper feed fields from read model to close remaining Phase E frontend spec gaps.
[x] P3.1 Add Sepolia keeper observability command that reports phase windows and deterministic next keeper action.
[x] P3.2 Add keeper operator runbook covering transition calls, observability cadence, and failure responses.
[x] P3.3 Extend keeper observability output with executable transition command hints.
[x] P3.4 Add keeper tick automation command with dry-run/execute modes driven by observability output.
[x] P3.5 Add recurring keeper loop command with interval/iteration controls for operator sessions.

### 20.4 Validation Gates

- Core suite: `bun run test`
- Gas regression: `bun run test:contracts:gas`
- Web quality: `bun run lint:web` and `cd apps/web && bun run build`
- Sepolia benchmark gate: `SHAPE_SEPOLIA_RPC_URL=... ROUND_ADDRESS=... bun run benchmark:sepolia:max-batch`
- Sepolia rollout gate: `SHAPE_SEPOLIA_RPC_URL=... DEPLOYER_PRIVATE_KEY=... bun run rollout:sepolia:max-batch`
- Sepolia smoke gate: `SHAPE_SEPOLIA_RPC_URL=... ROUND_ADDRESS=... bun run smoke:sepolia:round`
- Sepolia keeper observability: `SHAPE_SEPOLIA_RPC_URL=... ROUND_ADDRESS=... bun run observe:sepolia:keeper`
- Sepolia release gate: `SHAPE_SEPOLIA_RPC_URL=... ROUND_ADDRESS=... bun run release:gate:sepolia`

### 20.5 Risks and Mitigations

- Simulation integration may exceed gas envelope at higher batch sizes; mitigate with benchmark lock + CI gas gates.
- Contract/indexer/web semantic drift may create user-visible inconsistencies; mitigate with shared fixtures and reconciliation-driven integration tests.
- Payout path regressions under adversarial call ordering; mitigate with transfer-path probe tests + strict accounting invariants.
